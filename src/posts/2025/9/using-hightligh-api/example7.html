<play-ground fold="29">
  <template>
    <blockquote>
      <label for="search">
        Search the text for:
        <input type="text" id="search" placeholder="Search string" />
      </label>
      <high-lighter
        ><p>
          Cats are intriguing animals that make excellent pets. Their
          independence, grace, and intelligence allow them to adapt to any
          living situation. Furthermore, their ability to maintain themselves
          and hunt makes them low-maintenance and practical companions. Unlike
          dogs, who sometimes want continual attention and care from their
          owners, cats are satisfied to do their own thing and enjoy the company
          of their own. They have an inherent feeling of independence that
          distinguishes them from other tamed animals. Furthermore, their slim
          and nimble bodies move with elegance and beauty that no other animal
          can match. They are natural born athletes, and it is a thrill to watch
          them leap, pounce, and play.
        </p></high-lighter
      >
      <cite
        ><high-lighter
          ><a
            href="https://www.reddit.com/r/AwardBonanza/comments/12lv9hd/comment/jg84gwe/"
            >Some reddit user</a
          ></high-lighter
        ></cite
      >
    </blockquote>
    <script type="module">
      // All custom elements need to share the same highlight
      const highlight = new Highlight();
      CSS.highlights.set("my-highlight", highlight);

      class Highlighter extends HTMLElement {
        slottedNode = null;
        _ranges = [];
        rangeObjects = [];

        // We create a setter so that if ranges property changes, we re-highlight
        set ranges(val) {
          this._ranges = val;

          this.highlightRanges();
        }

        get ranges() {
          return this._ranges;
        }

        constructor() {
          super();

          this.highlight = highlight;
          this.attachShadow({ mode: "open" });
          this.render();
          this.setSlottedNode();
        }

        setSlottedNode() {
          const nodeArray = this.shadowRoot
            .querySelector("slot")
            .assignedNodes();
          const nonEmptyNodes = nodeArray.filter(
            (node) => node.textContent.trim() !== "",
          );

          if (nonEmptyNodes.length > 1) {
            throw new Error(
              "<high-lighter> does not support multiple slotted elements",
            );
          }

          this.slottedNode = nonEmptyNodes[0];
        }

        createRanges() {
          if (this.ranges && this.ranges.length > 0) {
            for (const [start, end] of this.ranges) {
              const range = new Range();
              range.setStart(this.slottedNode.firstChild, start);
              range.setEnd(this.slottedNode.firstChild, end);

              // We save the ranges so we can clear just this instances
              // highlights later if we re-highlight
              this.rangeObjects.push(range);
            }
          }
        }

        clearRanges() {
          for (const range of this.rangeObjects) {
            this.highlight.delete(range);
          }
          this.rangeObjects = [];
        }

        highlightRanges() {
          // Clear out old ranges
          this.clearRanges();

          // Create and store new ranges
          this.createRanges();

          // Highlight
          for (const range of this.rangeObjects) {
            this.highlight.add(range);
          }
        }

        render() {
          this.shadowRoot.innerHTML = `<style>
          ::highlight(my-highlight) {
            background: purple;
            color: white;
          }
          </style><slot></slot>`;
        }
      }

      customElements.define("high-lighter", Highlighter);
    </script>
    <script type="module">
      const highLighters = Array.from(
        document.querySelectorAll("high-lighter"),
      );

      window.search.addEventListener("input", (event) => {
        const regex = new RegExp(event.target.value, "dig");

        highLighters.forEach((el) => {
          el.clearRanges();

          const results = Array.from(el.textContent.matchAll(regex));
          const resultRanges = results.map(({ indices }) => indices[0]);

          el.ranges = resultRanges;
        });
      });
    </script>
  </template>
</play-ground>
